{% extends "layout.html" %}
{% block javascript %}
    {{ super() }}
    <script type="text/javascript">

        var stations = [];
        var saved_alerts = [];
        var accordion_options = { heightStyle: "content" };

        var proj3857 = new OpenLayers.Projection("EPSG:3857");
        var proj4326 = new OpenLayers.Projection("EPSG:4326");
        var map;
        var features = [];
        var selectCtl;

        var opts = {
          lines: 15, // The number of lines to draw
          length: 38, // The length of each line
          width: 15, // The line thickness
          radius: 41, // The radius of the inner circle
          corners: 1, // Corner roundness (0..1)
          rotate: 0, // The rotation offset
          direction: 1, // 1: clockwise, -1: counterclockwise
          color: '#000', // #rgb or #rrggbb or array of colors
          speed: 1, // Rounds per second
          trail: 50, // Afterglow percentage
          shadow: false, // Whether to render a shadow
          hwaccel: false, // Whether to use hardware acceleration
          className: 'spinner', // The CSS class to assign to the spinner
          zIndex: 2e9, // The z-index (defaults to 2000000000)
          top: 150, // Top position relative to parent in px
          left: 124 // Left position relative to parent in px
        };

        function removeFromSavedAlerts(alert) {
            var remove_index = -1;
            for (var i = 0 ; i < saved_alerts.length ; i++) {
                if (saved_alerts[i]._id == alert._id) {
                    remove_index = i;
                    break;
                }
            }
            if (remove_index != -1) {
                saved_alerts.splice(remove_index,1);
            }
        }

        function showSavedMessage(alert) {
            var status = $("span#" + alert._id + "_spinner");
            status.text("Saved").fadeOut(1000, function() {
                status.text("");
                status.show();
            });
        }

        function updateAlert(alert, new_data) {
            $.ajax({
                type     : 'POST'
                ,url     : alert.edit_url
                ,data    : new_data
                ,async   : false
            });
            showSavedMessage(alert);
        }

        function buildAlert(alert) {

            $("<h3 />").attr("id",alert._id + "_h3")
                .append($(buildAlertHeader(alert)))
                .appendTo("#alerts");

            var d = $("<div />");

            d.append($(buildAlertContents(alert)));
            d.append($("<h5 />").html("Set a new Condition"));
            d.append(buildAddCondition(alert));
            d.append($("<h5 />").attr("name","settings").html("Alert Settings"))
            d.append($(buildAlertEdits(alert)));
            d.appendTo("#alerts");

            // Frequency
            var freq_select = $("select[name='" + alert._id + "_frequency']");
            // Select the current frequency
            freq_select.find("option").filter(function() {
                return this.text == alert.frequency;
            }).attr("selected", "selected");
            // Save frequency
            $("select[name='" + alert._id + "_frequency']").change(function() {
                updateAlert(alert, { frequency: parseInt($(this).val()) })
            })

            // Buffer
            var burf_select = $("select[name='" + alert._id + "_buffer']");
            // Select the current buffer
            burf_select.find("option").filter(function() {
                return this.text == alert.buffer;
            }).attr("selected", "selected");
            // Save buffer
            $("select[name='" + alert._id + "_buffer']").change(function() {
                updateAlert(alert, { buffer: parseInt($(this).val()) })
            })

            // Make icon trigger edit
            $("#" + alert._id + "_h3 .alert_edit_img").click(function() {
                $("#" + alert._id + "_h3 .alert_title").editable(function(value,settings) {
                    updateAlert(alert, { name: value });
                    return value;
                }, {
                    onblur      : 'submit',
                    width       : 300
                });
                $("#" + alert._id + "_h3 .alert_title").click();
            });

        }

        function buildAlertEdits(alert) {

            var root = $("<div />");

            var freq = $("<div />").append($("<span />").html("Notify me every "));
            freq.append($("<span />")
                .html('<select type="select" name="' + alert._id + '_frequency"><option value="10">10 minutes</option><option value="20">20 minutes</option><option value="40">40 minutes</option><option value="60">1 hour</option><option value="360">6 hours</option><option value="720">12 hours</option><option value="1440">1 day</option></select>'));

            var buf = $("<div />").append($("<span />").html("All Conditions must be met within "));
            buf.append($("<span />")
                .html('<select type="select" name="' + alert._id + '_buffer"><option value="10">10 minutes</option><option value="20">20 minutes</option><option value="40">40 minutes</option><option value="60">1 hour</option><option value="360">6 hours</option><option value="720">12 hours</option><option value="1440">1 day</option></select>'))
                .append($("<span />").html(" of each other"));

            return root.append(freq).append(buf);

        }

        function buildAlertHeader(alert) {

            var del_link =  $("<a />")
                                .attr("class","alert_delete")
                                .attr("href", alert.destroy_url)
                                .on("click", function(e) {
                                    e.preventDefault();
                                    $.post(alert.destroy_url
                                        ,null
                                        ,function() {
                                            // Remove alert from saved_alerts
                                            removeFromSavedAlerts(alert);

                                            var header = $(e.currentTarget).closest('h3');
                                            var contents = header.next('div');

                                            // Only refresh map when we delete the active alert or remove last alert
                                            if ((contents.css("display") != "none") || (saved_alerts.length == 0)) {
                                                syncMapWithAlert(null);
                                            }

                                            header.remove();
                                            contents.remove();
                                            $( "#alerts" ).accordion( "refresh" );

                                        });
                                    return false;
                                });
             var status = $("<span />")
                            .attr("class","alert_spinner")
                            .attr("id", alert._id + "_spinner");

            return $("<div />")
                              .append($("<span />").attr("class","alert_title").html(alert.name))
                              .append($("<img />").attr("class", "alert_edit_img").attr("src","{{ url_for('.static', filename='images/edit.png') }}"))
                              .append(del_link)
                              .append(status)
                              .append("<br />")
                              .append($("<span />").attr('class','last_text').html("Last checked: " + alert.checked))
                              .append("<br />")
                              .append($("<span />").attr('class','last_text').html("Last notification sent: " + alert.sent))
        }

        function buildAlertContents(alert) {

            // Add conditions
            var ul = $("<ul />").attr("class","conditions_list");
            // this matches conditions with the correct station and lists them
            // under the station headings.  this is ugly.
            var last_station_id = null;
            var last_station_dom = null;
            for (var j = 0 ; j < alert.conditions.length ; j++) {
                var this_station_id = alert.conditions[j].station_id;

                if (this_station_id != last_station_id) {
                    // Add the last station
                    ul.append(last_station_dom);

                    // Build station section
                    last_station_dom = buildStationHeading(this_station_id);
                    last_station_id = this_station_id;
                }

                last_station_dom.append(buildCondition(alert, alert.conditions[j]));
            }
            ul.append(last_station_dom);

            classifyList(ul);

            return ul;
        }

        function buildStationHeading(station_id) {
            station = findStationById(station_id);
            var d = $('<li />').attr('id', station_id);


            var station_name = (station.provider + " - " + station.description)
            if (station_name.length > 50) {
                station_name = station_name.slice(0,50) + "...";
            }

            // If there is a station link, create the link
            if (station.link != "") {
                d.append($("<a />")
                // Zoom to the station on the map.  The stations popup has a link to the
                // external station page.
                .attr("href","javascript:zoomToStationById('" + station_id + "')")
                .html(station_name))
            } else {
                d.append($("<span />").html(station_name));
            }

            return d
        }

        function buildCondition(alert, cond) {

            data = cond['values'];
            times = cond['times'];

            var root = $('<div />').attr("class", "condition");

            root.append($("<span />").html(cond.variable + " (" + cond.units + ") " + cond.comparator + " " + cond.value));

            // Delete button
            root.append($("<a />")
                            .attr("class","condition_delete")
                            .attr("href", cond.destroy_url)
                            .on("click", function(e) {
                                e.preventDefault();
                                $.post(cond.destroy_url
                                    ,null
                                    ,function() {
                                        var station_div = $(e.currentTarget).parent().parent();
                                        var list_div = station_div.parent();
                                        // Remove condition that was clicked
                                        $(e.currentTarget).parent().remove();
                                        // Remove station heading if there are no more conditions
                                        if (station_div.find("div").length == 0) {
                                            station_div.remove();
                                        }
                                        // Remove condition from saved_alerts
                                        var remove_index = -1;
                                        var active_index = getActiveAlertIndex();
                                        for (var i = 0 ; i < saved_alerts[active_index].conditions.length ; i++) {
                                            if (saved_alerts[active_index].conditions[i]._id == cond._id) {
                                                remove_index = i;
                                                break;
                                            }
                                        }
                                        if (remove_index != -1) {
                                            saved_alerts[active_index].conditions.splice(remove_index, 1);
                                        }

                                        $( "#alerts" ).accordion( "refresh" );
                                        classifyList(list_div);
                                        syncMapWithAlert(alert);
                                        showSavedMessage(alert);
                                    }
                                )})
                        );

            var holder = $("<span />").css("float","right");

            if (data.length > 1) {
                var linechart = $("<span />").attr("class", "linechart");
                first = new Date(Date.parse(times[0]));
                last = new Date(Date.parse(times[times.length - 1]))
                holder.append($("<span />").attr("class","tinydate").html(first.format("m/d") + " " + first.format("h:MM")));

                linechart.sparkline(data, {
                    type: 'line',
                    width: '100',
                    height: '15',
                    lineColor: '#0078ae',
                    fillColor: '#acdd4a',
                    spotRadius: 0,
                    lineWidth: 1
                });
                holder.append(linechart);
                holder.append($("<span />").attr("class","tinydate").html(last.format("m/d") + " " + last.format("h:MM")));
            } else if (data.length == 1) {
                holder.html(data[0] + " on " + (new Date(Date.parse(times[0])).format("mmm d h:MM TT Z")));
            } else {
                holder.html(" - No recent data - ");
            }

            root.append(holder);

            return root;
        }

        function findStationByIndex(index) {
            return stations[index];
        }

        function findStationById(id) {
            for (var i = 0 ; i < stations.length ; i++) {
                if (stations[i]._id == id) {
                    return stations[i];
                }
            }
            return null;
        }

        function buildStationSelect(click_callback) {

            var root = $("<div />")

            var label = $("<label />").attr("for","station").text("Station");

            var stat = $("<select />")
                            .attr("name", "station")
                            .attr("disabled", "disabled")
                            .on("change", function(e) { click_callback(e); });
            // Set value to the index into the station array
            options = ""
            options += "<option></option>";
            $.each(stations, function(i,s) {
                options += "<option value='" + s._id + "'>" + s.provider + " - " + s.description + "</option>";
            });
            stat.append(options);

            root.append(label);
            root.append(stat);

            return root;
        }

        function buildAddCondition(alert) {

            // Create form
            var root = $("<form />").attr("class","add_condition").attr("name", alert._id);

            // Add station select
            root.append(buildStationSelect(function(clicker) {
                target = $(clicker.currentTarget);
                station = findStationById(target.val());

                var_select = target.parent().parent().find("select[name=variable]");
                var_select.empty();

                if (station.most_recent_obs.length < 1) {
                    variable.append($("<option />")
                                        .attr("value", "")
                                        .html("Station not reporting, please check back at a later time to add more alerts"));
                    target.parent().parent().find("button[name=add]").attr("disabled", "disabled");
                } else {
                    $.each(station.most_recent_obs, function(k,v) {
                        var_select.append($("<option />")
                                            .attr("value", k)
                                            .html(k));
                    });
                    var_select.on("change", function(e) {
                                                t = $(e.currentTarget);
                                                units_select = t.parent().parent().find("select[name=units]");
                                                units_select.empty();
                                                if (station.most_recent_obs.hasOwnProperty(t.val())) {
                                                    $.each(station.most_recent_obs[t.val()].values, function(u, value) {
                                                        units_select.append($("<option />")
                                                            .attr("value", u)
                                                            .html(u));
                                                    });
                                                }
                                            });
                    var_select.trigger("change");
                    target.parent().parent().find("button[name=add]").removeAttr("disabled");
                }

            }));

            root.append($("<label />").attr("for", "variable").text("Variable"));
            root.append($("<select />")
                            .attr("name", "variable"));

            root.append($("<label />").attr("for", "units").text("Unit"));
            root.append($("<select />")
                            .attr("name", "units"));

            root.append($("<label />").attr("for", "comparator").text("Comparator"));
            root.append($("<select />")
                            .attr("name", "comparator")
                            .append($("<option />")
                                .attr("value", "<")
                                .text("<"))
                            .append($("<option />")
                                .attr("value", ">")
                                .text(">"))
                            .append($("<option />")
                                .attr("value", "=")
                                .text("=")));

            root.append($("<label />").attr("for", "value").text("Value"));
            root.append($("<input />")
                            .attr("name", "value")
                            .attr("type", "textfield"));

            root.append($("<button />")
                            .attr("name", "add")
                            .attr("id", alert._id)
                            .html("Create alert")
                            .on("click", function(e) {
                                e.preventDefault();
                                var link =  $(this);

                                // Add the disabled station field to the submitted data
                                var submit_data = $("form[name=" + link.attr("id") + "]").serialize();
                                submit_data += "&station=" + $("form[name=" + link.attr("id") + "]").find('select[name="station"]').val();

                                $.post(alert.new_condition_url
                                    ,submit_data
                                    ,function(condition) {
                                        if (condition["error"]) {
                                            $("#messages").html("<div class='flash'>" + condition["error"] + "</div>");
                                        } else {

                                            var ul_list = $("form[name=" + link.attr("id") + "]").parent().find("ul")

                                            // Add condition to saved_alerts
                                            getActiveAlert().conditions.push(condition);

                                            var station_dom = ul_list.find("li#" + condition.station_id);
                                            if (station_dom.length == 0) {
                                                station_dom = buildStationHeading(condition.station_id);
                                                ul_list.append(station_dom);
                                                //$("form[name=" + link.attr("id") + "]").before(station_dom);
                                            }
                                            station_dom.append(buildCondition(alert, condition));

                                            classifyList(station_dom.closest("ul"));

                                            $.sparkline_display_visible();
                                            $( "#alerts" ).accordion( "refresh" );
                                            syncMapWithAlert(alert,true);
                                            showSavedMessage(alert);
                                        }

                                    }
                                )})
                            );

            return root;
        }

        function classifyList(element) {
            $.each($(element).find("li"), function(i,e) {
                $(e).attr("class", i % 2 == 0 ? "even" : "odd");
            });
        }

        function classifyTable(element) {
            $.each($(element).find("tr"), function(i,e) {
                $.each($(e).find("td.popupCondition"), function(k,f) {
                    new_class = i % 2 == 0 ? "even" : "odd";
                    $(f).attr("class", $(f).attr("class") + " " +  new_class);
                });
            });
        }

        function addAlert(alert) {
            if (alert["error"]) {
               $("#messages").html("<div class='flash'>" + alert["error"] + "</div>");
            } else {
                saved_alerts.push(alert);
                buildAlert(alert);
                $( "#alerts" ).accordion( "refresh" );
                $( "#alerts" ).accordion({ active: -1 });
                showSavedMessage(alert);
            }
        }

        function popup(f,showSensors) {
          var station = findStationById(f.cluster ? f.cluster[0].attributes._id : f.attributes._id);
          var atts = f.cluster ? f.cluster[0].attributes : f.attributes;
          var rows = [];
          var lines = 0; // keep track of how many data lines there are in order to set the height of the popup
          var timeFound;
          // SHOES
          // f.attributes.conditions is where it's at.
          if (showSensors) {
            for (var obsName in station.most_recent_obs) {
              if (!timeFound) {
                timeFound = true;
                rows.unshift('<td colspan=3>' + (new Date(Date.parse(station.most_recent_obs[obsName].time))).format("mmm d h:MM TT Z") + '</td>');
                lines++;
              }
              var obsVals = [];
              for (var obsUnit in station.most_recent_obs[obsName].values) {
                obsVals.push(String(station.most_recent_obs[obsName].values[obsUnit] + ' ' + obsUnit).replace(/ /g,'&nbsp;'));
              }
              if (obsVals.length == 0) {
                obsVals = ['---'];
              }
              var alertImg = '{{ url_for('.static', filename='images/blank.png') }}';

              // SHOES this is where you would test for the alert activity
              for (var i = 0 ; i < atts.conditions.length ; i++) {
                if (atts.conditions[i].variable == obsName && atts.conditions[i].triggering) {
                    alertImg = '{{ url_for('.static', filename='images/alert16.png') }}';
                }
              }

              rows.push(
                '<td class="popupCondition" align=left><a href="javascript:gotoCondition(\'' + station._id + '\',\'' + obsName + '\')">' + obsName + '</a></td>'
                + '<td class="popupCondition" align=right>' + obsVals.join('<br>') + '</td>'
                + '<td class="popupCondition"><img width=16 height=16 src="' + alertImg + '"></td>'
              );
              lines += obsVals.length;
            }
            rows.push('<td colspan=3 align=center><font color=gray>Click on a sensor link to access alert settings.</font></td>');
            lines++;
            rows.push('<td colspan=3 align=center><font color=gray>Click <a href="' + station.link + '" target=\'_blank\'>here</a> for station information.</font></td>');
            lines++;
          }
          else {
            rows.push('<td align=center><font color=gray>Click the icon to view sensor details.</font></td>');
            lines++;
          }
          rows.unshift('<th colspan=3>' + station.provider + ' - ' + station.description + '</th>');
          lines++;
          var centroid = f.geometry.getCentroid();
          map.popup = new OpenLayers.Popup.FramedCloud(
             'popup'
            ,new OpenLayers.LonLat(centroid.x,centroid.y)
            ,null
            ,'<table cellspacing="0" class="buoyPopup"><tr>' + rows.join('</tr><tr>') + '</tr></table>'
            ,null
            ,showSensors
            ,function() {
              map.removePopup(map.popup);
              map.popup.destroy();
              delete map.popup;
            }
          );
          // map.popup.panMapIfOutOfView = false;
          map.popup.name = f.attributes.name;
          map.addPopup(map.popup,true);
          classifyTable($(".buoyPopup"));
          map.popup.setSize(new OpenLayers.Size(275,(lines + 1.5) * 20));
          gotoStation(station);
        }

        function recenterAndZoomToFeature(f) {
          var centroid = f.geometry.getCentroid();
          map.setCenter(new OpenLayers.LonLat(centroid.x,centroid.y),map.getZoom() + 1);
          if (map.popup) {
            map.removePopup(map.popup);
            map.popup.destroy();
            delete map.popup;
          }
        }

        function zoomToStationById(id) {
          var lyr = map.getLayersByName('Stations')[0];
          var f = lyr.features;
          for (var i = 0 ; i < f.length; i++) {
            for (var j = 0 ; j < f[i].cluster.length; j++) {
              if (f[i].cluster[j].attributes._id == id) {
                f[i].cluster[j].attributes.force = 1;
                var centroid = f[i].geometry.getCentroid();
                map.setCenter(new OpenLayers.LonLat(centroid.x,centroid.y),8);
                popup(f[i],true);
                return;
              }
            }
          }
          // Now populat the stations dropdown if it needs to be.

        }

        function getActiveAlertIndex() {
            var active_index = $( "#alerts" ).accordion( "option", "active" );
            if (active_index == -1) {
                return saved_alerts.length - 1
            } else if (active_index === false) {
                return null;
            } else {
                return active_index;
            }
        }

        function getActiveAlert() {
            var active_index = $( "#alerts" ).accordion( "option", "active" );
            if (active_index == -1) {
                active_alert = saved_alerts.slice(active_index, saved_alerts.length)[0];
            } else if (active_index === false) {
                active_alert = null;
            } else {
                active_alert = saved_alerts[active_index];
            }
            return active_alert;
        }

        function createNewAlert() {
            $.ajax({
                type    : 'POST',
                url     : "{{ url_for('new_alert') }}",
                data    : $("#alert_form").serialize(),
                async   : false,
            }).done(function(a) {
                addAlert(a);
                return a
            });
        }

        function gotoCondition(station_id, sensorName) {
          // This should set the Condition values to the station and parameter that was clicked,
          // allowing the user to quickly add an alert for this parameter.
          active_alert = getActiveAlert();
          if (active_alert == null) {
            // THERE ARE NO ALERTS
            active_alert = createNewAlert(active_alert);
          }

          var form_dom =  $("form[name=" + active_alert._id + "]")
          var station_dom =  form_dom.parent().find("#" + station_id);
          if (station_dom.length > 0) {
            // Highlight station listing
            station_dom.effect("highlight", {}, 1000);
          }

          $.when(
            // Populate condition fields with information
            form_dom.find("select[name=station]").val(station_id).trigger("change")
          ).done(function() {
            form_dom.find("select[name=variable]").val(sensorName).trigger("change");
            form_dom.effect("highlight", {}, 1000);
          });
        }

        function gotoStation(station) {
          // This should set the Condition values to the station that was selected
          // allowing the user to quickly add an alert for this station.
          active_alert = getActiveAlert();
          if (active_alert == null) {
            // THERE ARE NO ALERTS
            active_alert = createNewAlert(active_alert);
          }

          var form_dom =  $("form[name=" + active_alert._id + "]")
          var station_dom =  form_dom.parent().find("#" + station._id);
          if (station_dom.length > 0) {
            // Highlight station listing
            station_dom.effect("highlight", {}, 1000);
          }

          $.when(
            // Populate condition fields with information
            form_dom.find("select[name=station]").val(station._id).trigger("change")
          ).done(function() {
            form_dom.effect("highlight", {}, 1000);
          });

        }

        function pokeMap() {
          // the icons don't always update so, force it here
          if (map.getZoom() > 1) {
            map.zoomIn();
            map.zoomOut();
          }
          else {
            map.zoomOut();
            map.zoomIn();
          }
        }

        function syncMapWithAlert(alert,zoomTo) {

          var lyr = map.getLayersByName('Stations')[0];
          lyr.removeFeatures();
          // If null is passed in, just clear the map.

          var bbox = new OpenLayers.Bounds();
          for (var i = 0 ; i < features.length ; i++) {
            features[i].attributes.numAlertsWatched   = 0;
            features[i].attributes.numAlertsTriggered = 0;
            features[i].attributes.force              = 0;
            features[i].attributes.conditions         = [];
            if (alert != null) {
                for (var k = 0 ; k < alert.conditions.length ; k++) {
                    // Does the Condition belogs to this station
                    if (features[i].attributes._id == alert.conditions[k].station_id) {
                        features[i].attributes.numAlertsWatched++;
                        if (alert.conditions[k].triggering) {
                            features[i].attributes.numAlertsTriggered++;
                            features[i].attributes.conditions.push(alert.conditions[k]);
                        }
                        bbox.extend(features[i].geometry.getBounds());
                    }
                }
            }
          }
          lyr.addFeatures(features);
          lyr.redraw();

          // zoom to the alert if we have a decent bbox
          if (zoomTo && typeof(bbox.bottom) == 'number') {
            var size = bbox.getSize();
            if (size.w == 0 && size.h == 0) {
              // oops, only 1 point in bbox, so set the center around it @ zoom level 8
              map.setCenter(bbox.getCenterLonLat(),8);
            }
            else {
              map.zoomToExtent(bbox);
            }
          }
          else {
            pokeMap();
          }

        }

        $(document).ready(function() {
            {%- if user.is_active() -%}

                var lyr = new OpenLayers.Layer.Vector(
                   'Stations'
                  ,{
                    styleMap : new OpenLayers.StyleMap({
                      'default': new OpenLayers.Style({
                           graphicZIndex   : "${getGraphicZIndex}"
                          ,externalGraphic : "${getExternalGraphic}"
                          ,graphicOpacity  : 1
                          ,graphicWidth    : "${getGraphicWidthHeight}"
                          ,graphicHeight   : "${getGraphicWidthHeight}"
                          ,pointRadius     : "${getPointRadius}"
                      }, {
                          context: {
                              getGraphicZIndex : function(feature) {
                                  if (feature.attributes.count == 1) {
                                      if (feature.cluster[0].attributes.numAlertsTriggered > 0) {
                                          return 10;
                                      }
                                      else if (feature.cluster[0].attributes.numAlertsWatched > 0) {
                                          return 5;
                                      }
                                      else {
                                          return 7;
                                      }
                                  }
                                  return 1;
                              }
                              ,getExternalGraphic : function(feature) {
                                  if (feature.attributes.count == 1) {
                                      if (feature.cluster[0].attributes.numAlertsTriggered > 0) {
                                          if (feature.cluster[0].attributes.numAlertsTriggered - feature.cluster[0].attributes.numAlertsWatched == 0) {
                                              return '{{ url_for('.static', filename='images/redtri.png') }}';
                                          }
                                          else {
                                              return '{{ url_for('.static', filename='images/bluetri.png') }}';
                                          }
                                      }
                                      else if (feature.cluster[0].attributes.numAlertsWatched > 0) {
                                          return '{{ url_for('.static', filename='images/greytri.png') }}';
                                      }
                                      else {
                                          return '{{ url_for('.static', filename='images/site20.png') }}';
                                      }
                                  }
                                  else {
                                      return '{{ url_for('.static', filename='images/magnifier16.png') }}';
                                  }
                              }
                              ,getGraphicWidthHeight : function(feature) {
                                  if (feature.attributes.count == 1) {
                                      if (feature.cluster[0].attributes.numAlertsTriggered > 0) {
                                          return 24;
                                      }
                                      else if (feature.cluster[0].attributes.numAlertsWatched > 0) {
                                          return 24;
                                      }
                                      else {
                                          return 20;
                                      }
                                  }
                                  return 16;
                              }
                              ,getPointRadius : function(feature) {
                                  if (feature.attributes.count == 1) {
                                      if (feature.cluster[0].attributes.numAlertsTriggered > 0) {
                                          return 24 / 2;
                                      }
                                      else if (feature.cluster[0].attributes.numAlertsWatched > 0) {
                                          return 24 / 2;
                                      }
                                      else {
                                          return 20 / 2;
                                      }
                                  }
                                  return 16 / 2;
                              }
                          }
                      })
                    })
                    ,strategies : [new OpenLayers.Strategy.Cluster({
                      rule: new OpenLayers.Rule({
                          filter: new OpenLayers.Filter.Logical({
                            type    : OpenLayers.Filter.Logical.AND
                           ,filters : [
                              new OpenLayers.Filter.Comparison({
                                   type     : OpenLayers.Filter.Comparison.EQUAL_TO
                                  ,property : 'numAlertsWatched'
                                  ,value    : 0
                              })
                              ,new OpenLayers.Filter.Comparison({
                                   type     : OpenLayers.Filter.Comparison.NOT_EQUAL_TO
                                  ,property : 'force'
                                  ,value    : 1
                              })
                            ]
                          })
                      })
                      ,shouldCluster: function(cluster, feature) {
                          var superProto = OpenLayers.Strategy.Cluster.prototype;
                          return this.rule.evaluate(cluster.cluster[0]) &&
                                 this.rule.evaluate(feature) &&
                                 superProto.shouldCluster.apply(this,arguments);
                      }
                    })]
                    ,rendererOptions: {zIndexing: true}
                  }
                );
                selectCtl = new OpenLayers.Control.SelectFeature(
                   lyr
                  ,{
                     autoActivate   : true
                    ,eventListeners : {
                      featurehighlighted : function(e) {
                        if (e.feature.attributes.count == 1) {
                          popup(e.feature,true);
                        }
                        else {
                          recenterAndZoomToFeature(e.feature);
                        }
                      }
                    }
                  }
                );
                map = new OpenLayers.Map('map',{
                    layers             : [
                        new OpenLayers.Layer.XYZ(
                             'ESRI Ocean'
                            ,'http://services.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer/tile/${z}/${y}/${x}.jpg'
                            ,{
                                 sphericalMercator : true
                                ,isBaseLayer       : true
                            }
                        )
                        ,lyr
                    ]
                    ,projection        : proj3857
                    ,displayProjection : proj4326
                    ,units             : 'm'
                    ,maxExtent         : new OpenLayers.Bounds(-20037508,-20037508,20037508,20037508.34)
                });
                map.addControl(selectCtl);
                map.setCenter(new OpenLayers.LonLat(-84.4,44.0).transform(proj4326,proj3857),6);

               // for some reason, we need to tap the map after it has initialized, esp. Chrome
               setTimeout(function(){map.updateSize()},100);

                $( "#alerts" ).accordion(accordion_options);
                $( "#alerts" ).on("accordionactivate", function(event, ui) {
                    // Uncommenting this will poulate the station (and thus other fields) on load.
                    //$(ui.newPanel).find("select[name=station]").trigger("change");
                    $.sparkline_display_visible();

                    syncMapWithAlert(getActiveAlert() ,true);
                    $( "#alerts" ).accordion( "refresh" );
                });

                // Start alert spinner
                $('#alert_spin').spin(opts);

                // Get stations
                $.get("{{ url_for('stations') }}", function(ss) {
                    var allStations  = ss["stations"];
                    var stations2ids = {};
                    // filter out stations outside our AOI
                    var aoi = new OpenLayers.Format.GeoJSON().read(getAOI())[0].geometry.transform(proj4326,proj3857);
                    for (var i = 0 ; i < allStations.length ; i++) {
                        var f = new OpenLayers.Feature.Vector(
                          new OpenLayers.Geometry.Point(
                             allStations[i].coordinates[1]
                            ,allStations[i].coordinates[0]
                          ).transform(proj4326,proj3857)
                          ,{
                             _id                : allStations[i]._id
                            ,numAlertsWatched   : 0
                            ,numAlertsTriggered : 0
                            ,force              : 0
                          }
                        );
                        if (aoi.intersects(f.geometry)) {
                          features.push(f);
                          stations2ids[allStations[i].provider + ' - ' + allStations[i].description] = allStations[i]._id;
                          stations.push(allStations[i]);
                        }
                    }

                    var sortedStations = [];
                    for (var s in stations2ids) {
                      sortedStations.push(s);
                    }
                    sortedStations.sort(function(a,b) {
                      return a.toLowerCase().localeCompare(b.toLowerCase());
                    });
                    var searchStations = [];
                    for (var i = 0; i < sortedStations.length; i++) {
                      searchStations.push({label : sortedStations[i],id : stations2ids[sortedStations[i]]});
                    }

                    $("#search").autocomplete({
                       source    : searchStations
                      ,select    : function(e,ui) {
                        zoomToStationById(ui.item.id);
                      }
                      ,minLength : 0
                    }).focus(function() {
                      $(this).autocomplete('search',$(this).val());
                    });

                    $.get("{{ url_for('alerts') }}", function(alerts) {
                        alerts = alerts["alerts"];
                        for (var i = 0 ; i < alerts.length ; i++) {
                            saved_alerts.push(alerts[i]);
                            buildAlert(alerts[i]);
                        }
                        $( "#alerts" ).accordion( "refresh" );
                        $( "#alerts" ).accordion( "option", "active", 0 );
                        $.sparkline_display_visible();
                        syncMapWithAlert(saved_alerts[0],true);

                        // Stop alert spinners
                        $('#alert_spin').spin(false);
                        $('#alert_spin').css("display","none");
                    });
                });

                $("#alert_create_button").click(function() {
                    $.post("{{ url_for('new_alert') }}",
                        $("#alert_form").serialize(),
                        function(alert) {
                            addAlert(alert);
                        }
                    );
                });

                $("#timezone_select").change(function () {
                    $.post("{{ url_for('save_timezone') }}",
                        "timezone= " + $("#timezone_select").val(),
                        function(message) {
                            $("#messages").html("<div class='flash'>" + message['message'] + "</div>");
                        }
                    );
                });

            {%- else %}

                // Tooltip explaning what Alerts are
                $( document ).tooltip( {
                    position: {
                        my: "center bottom-20",
                        at: "center bottom",
                        using: function( position, feedback ) {
                          $( this ).css( position );
                          $( "<div>" )
                            .addClass( feedback.vertical )
                            .addClass( feedback.horizontal )
                            .appendTo( this );
                        }
                    }
                });

                $("#password").focus(function() {
                    $("input[name=iamanewuser]").first().trigger("click");
                })

            {%- endif -%}


        });
    </script>
{% endblock %}
{% block page %}

    {%- if user.is_active() -%}

        <div id='left_notes'>
        </div>
        <div id='right_notes'>
            <div>
                <span>Signed in as {{ user.email }} from </span>
                <select id="timezone_select" name="timezone">
                    {%- for t in timezones %}
                        {%- if t == user.timezone %}
                            <option value="{{t}}" selected="selected">{{t}}</option>
                        {%- else %}
                            <option value="{{t}}">{{t}}</option>
                        {%- endif %}
                    {%- endfor %}
                </select>
            </div>
            {%- if user.password != None %}
                <a href="{{ url_for('set_password') }}">change / set password</a>
            {%- endif %}
            <span> | </span>
            <a href="{{ url_for('logout') }}">sign out</a>
        </div>
        <br />
        <div id="page_wrapper">
            <div id='map_wrapper'>
                <h3>To get started, please search or locate a station below:</h3>
                <h6>Search for a station</h6>
                <input id="search"></input>
                <h6>Locate a station</h6>
                <div class="generic_spinner" id="station_spin"></div>
                <div id="map"></div>
                <div class="legend">
                    <div><img src="{{ url_for('.static', filename='images/redtri.png') }}" /><span>- All conditions at this station are triggered</span></div>
                    <div><img src="{{ url_for('.static', filename='images/bluetri.png') }}" /><span> - Some conditions at this station are triggered</span></div>
                    <div><img src="{{ url_for('.static', filename='images/greytri.png') }}" /><span> - No conditions at this station are triggered</span></div>
                </div>
            </div>
            <div id='alerts_wrapper'>
                <div class="generic_spinner" id="alert_spin"></div>
                <div id="alerts"></div>
                <br />
                <span>To add stations to a new group:
                    <br />
                    <button id="alert_create_button">Create a new Alert Group</button>
                </span>
            </div>
        </div>
        <div class="clear"></div>

    {%- else -%}

        <div id='welcome'>
            <h2>WELCOME!</h2>
            <p>
                This page allows you to create <span class="tooltip_text" title="Customized email messages to tell you when a particular parameter - such as water temperature - meets a specified condition for a specific location/station.">alerts</span> with different variables related to water
                temperature, salinity, wave height and direction for specific locations in the Great Lakes.  You may
                bookmark this page and return anytime to manage existing alerts or create new ones.
            </p>

            <hr />
            <br />

            <div class="logins" id="local_logins">
                <h3>Sign in with your GLOS Alerts account</h3>
                <p>Signing in with a GLOS Alerts account is not required, but will allow you greater flexibility and provide access to additional GLOS tools and features.</p>
                <form name="register" method="POST" action="{{ url_for('login_local') }}">
                    <label for="email">What is your email address?</label>
                    <input type="text" name="email" />
                    <br />
                    <label for="iamanewuser">Do you have a password?</label>
                    <ul>
                        <li>
                            <input type="radio" name="iamanewuser" value="false" checked="checked"/>Yes, I have a password:
                            <input type="password" name="password" id="password" />
                        </li>
                        <li><input type="radio" name="iamanewuser" value="true" />No, I am a new user.<br />
                        <li>
                            <a href="{{ url_for('forgot_password') }}" class="forgot_password">Forgot your password?</a>
                            <input type="submit" name="submit" value="Sign in" />
                        </li>
                    </ul>
                </form>
            </div>

            <div class="logins" id="social_logins">
                <h3>Sign in with Facebook or Google+</h3>
                <p>We only use the below services to verify your email address. No additional information is ever collected or shared.</p>
                <div id="login_buttons">
                    <a href="{{ url_for('login_google') }}">
                        <img src="{{ url_for('.static', filename='images/google.png') }}" />
                    </a>
                    <a href="{{ url_for('login_facebook') }}">
                        <img src="{{ url_for('.static', filename='images/facebook.png') }}" />
                    </a>
                </div>
                <div class="clear"></div>
            </div>

            <div class="clear"></div>

        </div>

    {%- endif -%}

{% endblock %}
